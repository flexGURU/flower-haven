<div class="category-form">
  <!-- Form Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h2 class="text-2xl font-bold text-gray-800">
        {{ isEditMode ? 'Edit Category' : 'Add New Category' }}
      </h2>
      <p class="text-gray-600 mt-1">
        {{ isEditMode ? 'Update category information' : 'Create a new category
        for your products' }}
      </p>
    </div>
  </div>

  <form [formGroup]="categoryForm" (ngSubmit)="onSubmit()">
    <div class="space-y-6">
      <!-- Category Information Card -->
      <p-card>
        <ng-template pTemplate="header"> </ng-template>

        <div class="space-y-6">
          <!-- Category Name -->
          <div>
            <label class="block text-sm font-medium mb-2"
              >Category Name *</label
            >
            <input
              type="text"
              pInputText
              formControlName="name"
              placeholder="Enter category name (e.g., Electronics, Clothing, Books)"
              class="w-full"
              [class.ng-invalid]="categoryForm.get('name')?.invalid && categoryForm.get('name')?.touched"
            />
            @if (categoryForm.get('name')?.invalid &&
            categoryForm.get('name')?.touched) {
            <small class="text-red-500">
              @if (categoryForm.get('name')?.errors?.['required']) {
              <span>Category name is required</span>
              } @if (categoryForm.get('name')?.errors?.['minlength']) {
              <span>Category name must be at least 2 characters long</span>
              } @if (categoryForm.get('name')?.errors?.['maxlength']) {
              <span>Category name cannot exceed 50 characters</span>
              }
            </small>
            }
          </div>

          <!-- Category Description -->
          <div>
            <label class="block text-sm font-medium mb-2">Description *</label>
            <textarea
              pInputTextarea
              formControlName="description"
              placeholder="Enter a detailed description of this category and what products it includes..."
              rows="4"
              class="w-full"
              [class.ng-invalid]="categoryForm.get('description')?.invalid && categoryForm.get('description')?.touched"
            ></textarea>
            <div class="flex justify-between items-center mt-1">
              @if (categoryForm.get('description')?.invalid &&
              categoryForm.get('description')?.touched) {
              <small class="text-red-500">
                @if (categoryForm.get('description')?.errors?.['required']) {
                <span>Description is required</span>
                } @if (categoryForm.get('description')?.errors?.['minlength']) {
                <span>Description must be at least 10 characters long</span>
                } @if (categoryForm.get('description')?.errors?.['maxlength']) {
                <span>Description cannot exceed 200 characters</span>
                }
              </small>
              } @else {
              <div></div>
              }
              <small class="text-gray-500">
                {{ categoryForm.get('description')?.value?.length || 0 }}/200
                characters
              </small>
            </div>
          </div>

          @if(currentImageUrl){
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Current Image</label>
            <div class="relative inline-block">
              <img
                [src]="currentImageUrl"
                alt="Current product image"
                class="w-32 h-32 object-cover rounded-lg border"
              />
              <button
                type="button"
                class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600"
                (click)="removeCurrentImage()"
                pTooltip="Remove image"
              >
                ×
              </button>
            </div>
          </div>
          }

          <div class="">
            <p-fileUpload
              #fileUpload
              mode="basic"
              accept="image/*"
              [maxFileSize]="5000000"
              (onSelect)="onImageSelect($event)"
              chooseLabel="Choose Image"
              [auto]="false"
              class="w-full"
            ></p-fileUpload>
          </div>

          @if(selectedImagePreview().length > 0 ) {
          <!-- Preview Selected Image -->
          <!-- Preview Selected Image -->
          <label class="block text-sm font-medium mb-2">Preview</label>
          <div class="relative inline-block">
            <img
              [src]="selectedImagePreview()"
              alt="Selected image preview"
              class="relative w-32 h-32 object-cover rounded-lg border"
            />

            <!-- Overlay Spinner -->
            @if (uploadInProgress()) {
            <div
              class="absolute inset-0 flex flex-col items-center justify-center bg-black bg-opacity-50 rounded-lg"
            >
              <p-progress-spinner
                strokeWidth="6"
                fill="transparent"
                [style]="{ width: '40px', height: '40px' }"
              ></p-progress-spinner>
              <span class="mt-2 text-white text-xs">Uploading...</span>
            </div>
            }

            <!-- Remove Button -->
            <button
              type="button"
              class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600"
              (click)="removeImagePreview()"
              pTooltip="Remove image"
            >
              ×
            </button>
          </div>

          <!-- Status Message -->
          <div class="mt-2">
            @if (imageUploadStatus() === 'error') {
            <p-message severity="error" text="Image Upload Failed"></p-message>
            }
          </div>

          }
        </div>
      </p-card>

      <!-- Form Actions -->
      <div class="flex flex-col md:flex-row gap-3 pt-4">
        <button
          pButton
          type="submit"
          [label]="isEditMode ? 'Update Category' : 'Create Category'"
          icon="pi pi-check"
          class="flex-1 p-button-lg"
          [loading]="saving"
          [disabled]="categoryForm.invalid"
        ></button>

        <button
          pButton
          type="button"
          label="Cancel"
          icon="pi pi-times"
          class="flex-1 p-button-outlined p-button-lg"
          (click)="onCancelModal()"
        ></button>
      </div>

      <!-- Success State Preview -->
      @if (categoryForm.valid) {
      <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
        <div class="flex items-center gap-3">
          <i class="pi pi-check-circle text-green-500"></i>
          <p class="text-sm text-green-600 font-medium">
            Category information is complete and ready to {{ isEditMode ?
            'update' : 'create' }}!
          </p>
        </div>
      </div>
      }
    </div>
  </form>
</div>

<p-toast></p-toast>
