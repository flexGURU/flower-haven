<div class="product-management">
  <!-- Page Header -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-3xl font-bold text-gray-800 m-2">Product Management</h1>
    </div>
    <button
      pButton
      type="button"
      label="Add New Product"
      icon="pi pi-plus"
      class="p-button-primary"
      (click)="showProductForm()"
    ></button>
  </div>

  <!-- Filters -->
  <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div>
        <label class="block text-sm font-medium mb-2">Search</label>
        <input
          type="text"
          pInputText
          [(ngModel)]="searchTerm"
          placeholder="Search products..."
          class="w-full"
          (input)="applyFilters()"
        />
      </div>
      <div>
        <label class="block text-sm font-medium mb-2">Category</label>
        <p-select
          [(ngModel)]="selectedCategory"
          [options]="categoryOptions"
          optionLabel="name"
          optionValue="id"
          placeholder="All Categories"
          class="w-full"
          (onChange)="applyFilters()"
        ></p-select>
      </div>

      <div>
        <label class="block text-sm font-medium mb-2">Stock Status</label>
        <p-select
          [(ngModel)]="stockFilter"
          [options]="stockOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="All Products"
          class="w-full"
          (onChange)="applyFilters()"
        ></p-select>
      </div>

      <div class="flex items-end">
        <button
          pButton
          type="button"
          label="Clear Filters"
          class="p-button-outlined w-full"
          (click)="clearFilters()"
        ></button>
      </div>
    </div>
  </div>

  @if (productQueryData.isLoading()) {
  <div class="flex justify-center items-center py-8">
    <div class="card flex justify-center">
      <p-progress-spinner strokeWidth="6" fill="transparent" />
    </div>
  </div>
  } @if(productQueryData.isError()){
  <p-message severity="error">Failed to Fetch Products</p-message>

  } @if (productQueryData.data()) {
  <div class="w-full flex flex-col gap-2 justify-center mb-4">
    <div class="bg-white rounded-lg shadow-sm px-5 flex justify-center">
      <p-table
        [tableStyle]="{ 'min-width': '80rem' }"
        [value]="filteredProducts"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="{first} out of  {totalRecords}"
        styleClass="p-datatable-striped"
        [globalFilterFields]="['name', 'description']"
      >
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 80px">Image</th>
            <th pSortableColumn="name">
              Name <p-sortIcon field="name"></p-sortIcon>
            </th>
            <th pSortableColumn="price">
              Price (KES) <p-sortIcon field="price"></p-sortIcon>
            </th>
            <th pSortableColumn="stockQuantity">
              Stock <p-sortIcon field="stockQuantity"></p-sortIcon>
            </th>
            <th pSortableColumn="createdAt">
              Created <p-sortIcon field="createdAt"></p-sortIcon>
            </th>
            <th style="width: 120px">Actions</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-product>
          <tr>
            <td>
              <img
                [src]="product.image_url"
                [alt]="product.name"
                class="w-10 h-10 object-cover rounded-lg"
              />
            </td>
            <td>
              <div>
                <p class="font-medium text-gray-900">{{ product.name }}</p>
                <p class="text-sm text-gray-500 truncate max-w-xs">
                  {{ product.description }}
                </p>
              </div>
            </td>
            <td class="font-semibold text-gray-900">
              {{ product.price | currency:'KES':'symbol':'1.2-2' }}
            </td>

            <td>
              <div class="flex items-center gap-2">
                <span class="font-medium">{{ product.stock_quantity }}</span>
                <p-badge
                  [severity]="getStockSeverity(product.stock_quantity)"
                ></p-badge>
              </div>
            </td>
            <td class="text-gray-600">
              {{ product.created_at | date:'medium' }}
            </td>
            <td>
              <div class="flex gap-1">
                <button
                  pButton
                  type="button"
                  icon="pi pi-eye"
                  class="p-button-text p-button-sm p-button-secondary"
                  (click)="viewProduct(product)"
                  pTooltip="View Details"
                  tooltipPosition="top"
                ></button>
                <button
                  pButton
                  type="button"
                  icon="pi pi-pencil"
                  class="p-button-text p-button-sm p-button-info"
                  (click)="editProduct(product)"
                  pTooltip="Edit Product"
                  tooltipPosition="top"
                ></button>
                <button
                  pButton
                  type="button"
                  icon="pi pi-trash"
                  class="p-button-text p-button-sm p-button-danger"
                  (click)="confirmDelete(product)"
                  pTooltip="Delete Product"
                  tooltipPosition="top"
                ></button>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="6" class="text-center py-12">
              <div class="text-gray-500">
                <i class="pi pi-box text-5xl mb-4 block text-gray-300"></i>
                <p class="text-lg font-medium mb-2">No products found</p>
                <p class="text-sm">
                  Try adjusting your search criteria or add a new product
                </p>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <p-paginator
      (onPageChange)="onPageChange($event)"
      [first]="first()"
      [rows]="15"
      [totalRecords]="total()"
      [rowsPerPageOptions]="[15,  30, 50]"
    />
  </div>
  }
</div>

<!-- Product Form Dialog/Popup -->
<p-dialog
  maskStyleClass="backdrop-blur-sm"
  [(visible)]="productForm"
  [header]="isEditMode ? 'Edit Product' : 'Add New Product'"
  [modal]="true"
  [closable]="true"
  [draggable]="true"
  [resizable]="true"
  [style]="{ width: '150vw', maxWidth: '1000px' }"
  [baseZIndex]="10000"
  styleClass="product-form-dialog"
  (onHide)="onFormClose()"
>
  <ng-template pTemplate="content">
    <div class="product-form-container">
      <app-product-form
        [productData]="selectedProduct"
        [isEditMode]="isEditMode"
        (onSave)="onProductSave($event)"
        (onCancelForm)="onFormCancel()"
      />
    </div>
  </ng-template>
</p-dialog>

<!-- Product Details Dialog -->
<p-dialog
  maskStyleClass="backdrop-blur-sm"
  [(visible)]="showProductDetails"
  header="Product Details"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '90vw', maxWidth: '900px' }"
  [baseZIndex]="10000"
>
  <ng-template pTemplate="content">
    <div class="product-details" *ngIf="selectedProduct">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <img
            [src]="selectedProduct.image_url"
            [alt]="selectedProduct.name"
            class="w-full h-64 object-cover rounded-lg border"
          />
        </div>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-600"
              >Product Name</label
            >
            <p class="text-lg font-semibold text-gray-900">
              {{ selectedProduct.name }}
            </p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-600"
              >Description</label
            >
            <p class="text-gray-800">
              {{ selectedProduct.description || 'No description available' }}
            </p>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-600"
                >Price</label
              >
              <p class="text-xl font-bold text-green-600">
                {{ selectedProduct.price | currency:'KES':'symbol':'1.2-2' }}
              </p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-600"
                >Stock</label
              >
              <div class="flex items-center gap-2">
                <span class="text-lg font-semibold"
                  >{{ selectedProduct.stock_quantity }}</span
                >
                <p-badge
                  [value]="getStockLabel(selectedProduct.stock_quantity)"
                  [severity]="getStockSeverity(selectedProduct.stock_quantity)"
                ></p-badge>
              </div>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-600"
              >Created Date</label
            >
            <p class="text-gray-800">
              {{ selectedProduct.createdAt | date:'full' }}
            </p>
          </div>
        </div>
      </div>
    </div>
  </ng-template>
  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-2">
      <button
        pButton
        type="button"
        label="Edit"
        icon="pi pi-pencil"
        class="p-button-primary"
        (click)="editProductFromDetails()"
      ></button>
      <button
        pButton
        type="button"
        label="Close"
        icon="pi pi-times"
        class="p-button-outlined"
        (click)="showProductDetails = false"
      ></button>
    </div>
  </ng-template>
</p-dialog>

<p-confirmDialog
  [style]="{ width: '450px' }"
  [baseZIndex]="10000"
></p-confirmDialog>

<p-toast />
