<div class="product-form">
  <!-- Form Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h2 class="text-2xl font-bold text-gray-800">
        {{isEditMode ? 'Edit Product' : 'Add New Product'}}
      </h2>
      <p class="text-gray-600 mt-1">
        {{isEditMode ? 'Update product information' : 'Create a new product for
        your catalog'}}
      </p>
    </div>
  </div>

  <form [formGroup]="productForm" (ngSubmit)="onSubmit()">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Main Product Info -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Basic Information -->
        <p-card>
          <ng-template pTemplate="header">
            <div class="p-4 border-b">
              <h3 class="text-lg font-semibold">Product Information</h3>
            </div>
          </ng-template>

          <div class="space-y-4">
            <!-- Product Name -->
            <div>
              <label class="block text-sm font-medium mb-2"
                >Product Name *</label
              >
              <input
                type="text"
                pInputText
                formControlName="name"
                placeholder="Enter product name"
                class="w-full"
                [class.ng-invalid]="productForm.get('name')?.invalid && productForm.get('name')?.touched"
              />
              <small
                *ngIf="productForm.get('name')?.invalid && productForm.get('name')?.touched"
                class="text-red-500"
              >
                Product name is required
              </small>
            </div>

            <!-- Description -->
            <div>
              <label class="block text-sm font-medium mb-2"
                >Description *</label
              >
              <textarea
                pInputTextarea
                formControlName="description"
                placeholder="Enter product description"
                rows="4"
                class="w-full"
                [class.ng-invalid]="productForm.get('description')?.invalid && productForm.get('description')?.touched"
              ></textarea>
              <small
                *ngIf="productForm.get('description')?.invalid && productForm.get('description')?.touched"
                class="text-red-500"
              >
                Description is required
              </small>
            </div>

            <!-- Price and Category -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-2"
                  >Price (KES) *</label
                >
                <p-inputNumber
                  formControlName="price"
                  mode="decimal"
                  [minFractionDigits]="2"
                  [maxFractionDigits]="2"
                  placeholder="0.00"
                  prefix="KES "
                  class="w-full"
                  [class.ng-invalid]="productForm.get('price')?.invalid && productForm.get('price')?.touched"
                ></p-inputNumber>
                <small
                  *ngIf="productForm.get('price')?.invalid && productForm.get('price')?.touched"
                  class="text-red-500"
                >
                  Price is required and must be greater than 0
                </small>
              </div>

              <div>
                <label class="block text-sm font-medium mb-2">Category *</label>
                <p-select
                  formControlName="categoryId"
                  [options]="categories"
                  optionLabel="name"
                  optionValue="id"
                  placeholder="Select category"
                  class="w-full"
                  [class.ng-invalid]="productForm.get('categoryId')?.invalid && productForm.get('categoryId')?.touched"
                ></p-select>
                <small
                  *ngIf="productForm.get('categoryId')?.invalid && productForm.get('categoryId')?.touched"
                  class="text-red-500"
                >
                  Category is required
                </small>
              </div>
            </div>
          </div>
        </p-card>

        <!-- Product Image -->
        <div class="mt-4">
          <p-card>
            <ng-template pTemplate="header">
              <div class="p-4 border-b">
                <h3 class="text-lg font-semibold">Product Image</h3>
              </div>
            </ng-template>

            <div class="space-y-4 mt-2">
              <!-- Current Image Preview -->
              <div *ngIf="currentImageUrl" class="mb-4">
                <label class="block text-sm font-medium mb-2"
                  >Current Image</label
                >
                <div class="relative inline-block">
                  <img
                    [src]="currentImageUrl"
                    alt="Current product image"
                    class="w-32 h-32 object-cover rounded-lg border"
                  />
                  <button
                    type="button"
                    class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600"
                    (click)="removeCurrentImage()"
                    pTooltip="Remove image"
                  >
                    ×
                  </button>
                </div>
              </div>

              <!-- Image Upload -->
              <div class="">
                <label class="block text-sm font-medium mb-2"
                  >Upload New Image</label
                >
                <p-fileUpload
                  #fileUpload
                  mode="basic"
                  accept="image/*"
                  [maxFileSize]="5000000"
                  (onSelect)="onImageSelect($event)"
                  chooseLabel="Choose Image"
                  [auto]="false"
                  class="w-full"
                ></p-fileUpload>
                <small class="text-gray-500 block mt-2">
                  Upload a single image (max 5MB). Supported formats: JPG, PNG,
                  GIF
                </small>
              </div>

              <!-- Preview Selected Image -->
              @if(selectedImagePreview().length > 0) {
              <div class="mt-4">
                <label class="block text-sm font-medium mb-2">Preview</label>
                <div class="relative inline-block">
                  <img
                    [src]="selectedImagePreview()"
                    alt="Selected image preview"
                    class="relative w-32 h-32 object-cover rounded-lg border"
                  />
                  <button
                    type="button"
                    class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600"
                    (click)="removeImagePreview()"
                    pTooltip="Remove image"
                  >
                    ×
                  </button>
                </div>
              </div>
              }
            </div>
          </p-card>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="mb-2 space-y-6">
        <!-- Stock Information -->
        <p-card>
          <ng-template pTemplate="header">
            <div class="p-4 border-b">
              <h3 class="text-lg font-semibold">Stock Information</h3>
            </div>
          </ng-template>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2"
                >Stock Quantity *</label
              >
              <p-inputNumber
                formControlName="stock"
                [min]="0"
                [step]="1"
                placeholder="0"
                [class.ng-invalid]="productForm.get('stock')?.invalid && productForm.get('stock')?.touched"
              ></p-inputNumber>
              <small
                *ngIf="productForm.get('stock')?.invalid && productForm.get('stock')?.touched"
                class="text-red-500"
              >
                Stock quantity is required
              </small>
            </div>

            <!-- Stock Status Display -->
            <div class="p-3 bg-gray-50 rounded-lg">
              <div class="flex items-center justify-between">
                <p-badge [severity]="getStockSeverity()"></p-badge>
              </div>
            </div>
          </div>
        </p-card>

        <!-- Form Actions -->
        <div class="space-y-3">
          <button
            pButton
            type="submit"
            [label]="isEditMode ? 'Update Product' : 'Create Product'"
            icon="pi pi-check"
            class="w-full p-button-lg mt-2"
            [loading]="saving()"
            [disabled]="productForm.invalid"
          ></button>

          <button
            pButton
            type="button"
            label="Cancel"
            icon="pi pi-times"
            class="w-full p-button-outlined"
            (click)="onCancel()"
          ></button>
        </div>

        <!-- Form Validation Summary -->
        <div
          *ngIf="productForm.invalid && productForm.touched"
          class="p-3 bg-red-50 border border-red-200 rounded-lg"
        >
          <p class="text-sm text-red-600 font-medium mb-2">
            Please fix the following errors:
          </p>
          <ul class="text-sm text-red-600 list-disc list-inside space-y-1">
            <li *ngIf="productForm.get('name')?.invalid">
              Product name is required
            </li>
            <li *ngIf="productForm.get('description')?.invalid">
              Description is required
            </li>
            <li *ngIf="productForm.get('price')?.invalid">
              Valid price is required
            </li>
            <li *ngIf="productForm.get('categoryId')?.invalid">
              Category must be selected
            </li>
            <li *ngIf="productForm.get('stock')?.invalid">
              Stock quantity is required
            </li>
          </ul>
        </div>
      </div>
    </div>
  </form>
</div>

<p-toast />
